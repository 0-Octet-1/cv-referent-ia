/**
 * ai-assistant.js
 * Assistant IA flottant avec explications contextuelles
 */

// Configuration des explications IA par dÃ©faut
const defaultAIExplanations = {
    'section-title': "Section clÃ© du profil de GrÃ©gory : 20 ans d'Ã©volution du dÃ©veloppement classique vers l'expertise en IA Ã©thique et solutions nutritionnelles innovantes.",
    'timeline-item': "Ã‰tape importante : progression naturelle de l'analyse programmeur vers le rÃ´le de RÃ©fÃ©rent IA, avec une expertise croissante en solutions mÃ©tier.",
    'skill-item': "CompÃ©tence maÃ®trisÃ©e : fait partie de l'arsenal technique de GrÃ©gory, acquise sur 20 ans d'expÃ©rience, du Windev aux technologies IA modernes.",
    'project-card': "RÃ©alisation concrÃ¨te : projet dÃ©veloppÃ© par GrÃ©gory, illustrant son expertise technique et son approche innovante des solutions mÃ©tier.",
    'contact-info': "Contactez GrÃ©gory pour vos projets IA Ã©thiques, dÃ©veloppement Windev/Python, ou accompagnement en transformation numÃ©rique."
};

// Messages IA contextuels selon la section
const contextualMessages = {
    'accueil': "ðŸ¤– Bonjour ! Je suis l'assistant IA de GrÃ©gory. Il a 20+ ans d'expÃ©rience en dÃ©veloppement et est aujourd'hui RÃ©fÃ©rent IA chez Techna, spÃ©cialisÃ© en solutions d'IA Ã©thiques.",
    'parcours': "ðŸ“ˆ Parcours impressionnant ! GrÃ©gory a Ã©voluÃ© d'analyse programmeur (2002) Ã  RÃ©fÃ©rent IA (2023). Expert Windev depuis 16 ans, il maÃ®trise maintenant Python/React et l'IA Ã©thique.",
    'competences': "ðŸ’» Stack technique solide : Expert Windev/Webdev, Python/Django, JavaScript/React. SpÃ©cialisÃ© en IA responsable, EDI, gestion commerciale et synthÃ¨se vocale innovante.",
    'realisations': "ðŸš€ Projets concrets : Outils IA nutritionnels chez Techna, plateforme WEFEED, systÃ¨me de gestion commerciale complet, innovation synthÃ¨se vocale pour le picking.",
    'contact': "ðŸ“ž Contactez GrÃ©gory pour vos projets d'IA Ã©thique ! Expert en dÃ©veloppement et transformation numÃ©rique, il saura vous accompagner dans vos innovations."
};

// Variables globales
let currentTooltipTimeout;
let currentTypingTimeout;
let isCurrentlyTyping = false;
let aiAssistant;
let aiTooltip;
let aiTooltipText;

// Fonction throttle pour optimiser le scroll
function throttle(func, limit) {
    let inThrottle;
    return function() {
        const args = arguments;
        const context = this;
        if (!inThrottle) {
            func.apply(context, args);
            inThrottle = true;
            setTimeout(() => inThrottle = false, limit);
        }
    }
}

// Initialisation
document.addEventListener('DOMContentLoaded', function() {
    aiAssistant = document.getElementById('ai-assistant');
    aiTooltip = document.getElementById('ai-tooltip');
    aiTooltipText = document.getElementById('ai-tooltip-text');
    
    // Initialiser les Ã©couteurs
    setupHoverListeners();
    setupSectionObserver();
    
    // Forcer le nettoyage du texte et afficher le message d'accueil
    setTimeout(() => {
        // Nettoyer complÃ¨tement le contenu
        aiTooltipText.innerHTML = '';
        aiTooltipText.textContent = '';
        
        const welcomeMessage = contextualMessages['accueil'] || "ðŸ’¡ DÃ©couvrez l'expertise de GrÃ©gory en naviguant sur le site";
        
        // Forcer le texte correct
        aiTooltipText.textContent = welcomeMessage;
        showAITooltip(welcomeMessage);
        
        // Double vÃ©rification aprÃ¨s 500ms
        setTimeout(() => {
            if (aiTooltipText.textContent !== welcomeMessage) {
                aiTooltipText.textContent = welcomeMessage;
            }
        }, 500);
    }, 1500);
    
    // Clic sur l'assistant pour afficher/masquer le tooltip
    const assistantIcon = aiAssistant.querySelector('.ai-assistant-icon');
    assistantIcon.addEventListener('click', toggleTooltip);
});

// Initialiser l'assistant IA
function initializeAIAssistant() {
    // Masquer l'assistant pendant la modal d'accueil
    if (document.getElementById('ai-welcome-modal')) {
        // Initialiser les Ã©couteurs
        setupHoverListeners();
        setupSectionObserver();
        
        // Afficher le message d'accueil immÃ©diatement et le laisser affichÃ©
        setTimeout(() => {
            const welcomeMessage = contextualMessages['accueil'] || "ðŸ’¡ Survolez les Ã©lÃ©ments pour dÃ©couvrir l'expertise de GrÃ©gory";
            aiTooltipText.textContent = welcomeMessage;
            showAITooltip(welcomeMessage);
        }, 1000);
        
        // Clic sur l'assistant pour afficher/masquer le tooltip
        const assistantIcon = aiAssistant.querySelector('.ai-assistant-icon');
        assistantIcon.addEventListener('click', toggleTooltip);
    } else {
        showWelcomeTooltip();
    }
}

// Afficher le tooltip de bienvenue - DÃ‰SACTIVÃ‰
function showWelcomeTooltip() {
    // Fonction dÃ©sactivÃ©e pour Ã©viter les messages automatiques
}

// Configurer les Ã©couteurs de survol
function setupHoverListeners() {
    // Ã‰lÃ©ments avec attribut data-ai-info
    document.querySelectorAll('[data-ai-info]').forEach(element => {
        element.addEventListener('mouseenter', function(e) {
            const aiInfo = this.getAttribute('data-ai-info');
            showAITooltip(aiInfo);
        });
        
        element.addEventListener('mouseleave', function() {
            hideAITooltip();
        });
    });
    
    // Ã‰lÃ©ments avec classes spÃ©cifiques
    setupClassBasedHovers();
}

// Configurer les survols basÃ©s sur les classes - DÃ‰SACTIVÃ‰
function setupClassBasedHovers() {
    // Fonction dÃ©sactivÃ©e pour Ã©viter les textes gÃ©nÃ©rÃ©s automatiquement
    // Seuls les messages au clic sur l'icÃ´ne sont conservÃ©s
}

// Observer pour dÃ©tecter la section active avec scroll listener
function setupSectionObserver() {
    const sections = document.querySelectorAll('section[id]');
    let currentSection = 'accueil';
    
    // Fonction pour dÃ©tecter la section active
    function detectActiveSection() {
        const scrollPosition = window.scrollY + window.innerHeight / 3;
        
        for (let section of sections) {
            const sectionTop = section.offsetTop;
            const sectionBottom = sectionTop + section.offsetHeight;
            
            if (scrollPosition >= sectionTop && scrollPosition <= sectionBottom) {
                const sectionId = section.id;
                
                // Si la section a changÃ©
                if (sectionId !== currentSection) {
                    currentSection = sectionId;
                    const message = contextualMessages[sectionId];
                    
                    if (message) {
                        // Forcer l'arrÃªt de toute animation en cours
                        clearTimeout(currentTypingTimeout);
                        isCurrentlyTyping = false;
                        
                        // Afficher le nouveau message
                        showAITooltip(message);
                    }
                }
                return;
            }
    }
    
    // Ã‰couter le scroll avec throttling
    let scrollTimeout;
    window.addEventListener('scroll', throttle(detectActiveSection, 100));
    
    // DÃ©tecter la section initiale
    setTimeout(detectActiveSection, 500);
}

// Mettre Ã  jour le message contextuel selon la section
function updateContextualMessage(sectionId) {
    const message = contextualMessages[sectionId];
        // Mettre Ã  jour le message par dÃ©faut de l'assistant
        setTimeout(() => {
            if (!aiTooltip.classList.contains('show')) {
                aiTooltipText.textContent = message;
            }
        }, 500);
    }
}

// Afficher le tooltip IA avec effet de frappe sÃ©curisÃ©
function showAITooltip(message) {
    clearTimeout(currentTooltipTimeout);
    clearTimeout(currentTypingTimeout);
    
    // ArrÃªter toute animation en cours
    isCurrentlyTyping = false;
    
    aiTooltip.classList.add('show');
    
    // Petit dÃ©lai pour s'assurer que l'animation prÃ©cÃ©dente est arrÃªtÃ©e
    setTimeout(() => {
        // Effet de frappe pour les messages longs
        if (message.length > 60) {
            typeWriterEffectSafe(aiTooltipText, message);
        } else {
            aiTooltipText.textContent = message;
        }
    }, 50);
}

// Masquer le tooltip IA
function hideAITooltip() {
    currentTooltipTimeout = setTimeout(() => {
        aiTooltip.classList.remove('show');
    }, 300);
}

// Basculer l'affichage du tooltip
function toggleTooltip() {
    if (aiTooltip.classList.contains('show')) {
        hideAITooltip();
    } else {
        const currentSection = getCurrentSection();
        const message = contextualMessages[currentSection] || "Je suis votre assistant IA ! Survolez les Ã©lÃ©ments pour plus d'informations.";
        showAITooltip(message);
    }
}

// Obtenir la section actuelle
function getCurrentSection() {
    const sections = document.querySelectorAll('section[id]');
    const scrollPosition = window.scrollY + window.innerHeight / 2;
    
    for (let section of sections) {
        const sectionTop = section.offsetTop;
        const sectionBottom = sectionTop + section.offsetHeight;
        
        if (scrollPosition >= sectionTop && scrollPosition <= sectionBottom) {
            return section.id;
        }
    }
    
    return 'accueil';
}

// Effet de frappe sÃ©curisÃ© pour Ã©viter les conflits
function typeWriterEffectSafe(element, text, speed = 20) {
    // VÃ©rifier que le texte est valide
    if (!text || typeof text !== 'string') {
        element.textContent = "ðŸ’¡ Informations sur l'expertise de GrÃ©gory";
        return;
    }
    
    // Marquer qu'on commence Ã  taper
    isCurrentlyTyping = true;
    
    // Nettoyer l'Ã©lÃ©ment
    element.textContent = '';
    let i = 0;
    
    function type() {
        // VÃ©rifier qu'on doit continuer
        if (!isCurrentlyTyping || i >= text.length) {
            isCurrentlyTyping = false;
            return;
        }
        
        // Ajouter le caractÃ¨re suivant
        const char = text.charAt(i);
        element.textContent += char;
        i++;
        
        // Programmer le caractÃ¨re suivant
        currentTypingTimeout = setTimeout(type, speed);
    }
    
    // Commencer l'animation
    type();
}

// Ajouter des explications dynamiques aux nouveaux Ã©lÃ©ments
function addAIExplanation(element, explanation) {
    element.setAttribute('data-ai-info', explanation);
    
    element.addEventListener('mouseenter', function() {
        showAITooltip(explanation);
    });
    
    element.addEventListener('mouseleave', function() {
        hideAITooltip();
    });
}

// Animation de particules autour de l'assistant
function createAssistantParticles() {
    const assistant = document.querySelector('.ai-assistant-icon');
    const rect = assistant.getBoundingClientRect();
    
    for (let i = 0; i < 3; i++) {
        const particle = document.createElement('div');
        particle.style.cssText = `
            position: fixed;
            width: 4px;
            height: 4px;
            background: var(--primary-color);
            border-radius: 50%;
            pointer-events: none;
            z-index: 10000;
            animation: particle-float-assistant 2s ease-out forwards;
        `;
        
        const angle = (Math.PI * 2 * i) / 3;
        const distance = 30;
        const startX = rect.left + rect.width / 2;
        const startY = rect.top + rect.height / 2;
        
        particle.style.left = startX + 'px';
        particle.style.top = startY + 'px';
        
        document.body.appendChild(particle);
        
        setTimeout(() => {
            const endX = startX + Math.cos(angle) * distance;
            const endY = startY + Math.sin(angle) * distance;
            
            particle.style.left = endX + 'px';
            particle.style.top = endY + 'px';
            particle.style.opacity = '0';
        }, 100);
        
        setTimeout(() => {
            if (particle.parentNode) {
                particle.parentNode.removeChild(particle);
            }
        }, 2000);
    }
}

// Ajouter l'animation des particules
const assistantParticleKeyframes = `
@keyframes particle-float-assistant {
    0% {
        transform: scale(1);
        opacity: 1;
    }
    100% {
        transform: scale(0);
        opacity: 0;
    }
}
`;

const style = document.createElement('style');
style.textContent = assistantParticleKeyframes;
document.head.appendChild(style);

// DÃ©clencher l'effet de particules pÃ©riodiquement
setInterval(() => {
    if (Math.random() < 0.3) { // 30% de chance
        createAssistantParticles();
    }
}, 5000);

// Export pour utilisation externe
window.AIAssistant = {
    showTooltip: showAITooltip,
    hideTooltip: hideAITooltip,
    addExplanation: addAIExplanation
};
